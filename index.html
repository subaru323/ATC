<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>ATC „Ç®„Ç≥„ÇØ„Ç§„Ç∫ - Êâã„ÅßÁ≠î„Åà„ÇãÁí∞Â¢É„ÇØ„Ç§„Ç∫</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.2.1617146986/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.1.1617146909/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.1.1617147326/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/face_mesh.js" crossorigin="anonymous"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', '„É°„Ç§„É™„Ç™', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .input_video {
            display: none;
        }
        
        .output_canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scaleX(-1);
            max-width: 95vw;
            max-height: 95vh;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        #quiz-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        #question {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            padding: 30px 50px;
            border-radius: 20px;
            font-size: 32px;
            font-weight: bold;
            color: #333;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 80%;
        }
        
        .choice-box {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            padding: 60px 80px;
            border-radius: 20px;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-width: 350px;
        }
        
        #choice-left {
            left: 10%;
        }
        
        #choice-right {
            right: 10%;
        }
        
        .choice-box.hover {
            transform: translateY(-50%) scale(1.1);
            background: rgba(144,238,144,0.95);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .choice-box.correct {
            animation: correctAnim 0.5s;
        }
        
        .choice-box.wrong {
            animation: wrongAnim 0.5s;
            background: rgba(255,100,100,0.95) !important;
        }
        
        @keyframes correctAnim {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.2); }
        }
        
        @keyframes wrongAnim {
            0%, 100% { transform: translateY(-50%) translateX(0); }
            25% { transform: translateY(-50%) translateX(-10px); }
            75% { transform: translateY(-50%) translateX(10px); }
        }
        
        #score {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        #countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: bold;
            color: rgba(255,255,255,0.3);
            display: none;
        }
        

        
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            pointer-events: none;
            animation: particleFall 2s linear;
        }
        
        @keyframes particleFall {
            from {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            to {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <video class="input_video"></video>
        <canvas class="output_canvas" width="1280" height="720"></canvas>
        
        <div id="quiz-overlay">
            <div id="question">„Ç´„É°„É©„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            <div id="choice-left" class="choice-box"></div>
            <div id="choice-right" class="choice-box"></div>
            <div id="score">„Çπ„Ç≥„Ç¢: 0/5</div>
            <div id="countdown"></div>
        </div>
        

    </div>

    <script type="module">
        const videoElement = document.querySelector('.input_video');
        const canvasElement = document.querySelector('.output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        
        // „ÇØ„Ç§„Ç∫„Éá„Éº„Çø
        const quizData = [
            {
                question: "„ÅäË≤∑„ÅÑÁâ©„ÄÅ„Å©„Å£„Å°„Åå„Ç®„Ç≥Ôºü",
                left: { text: "„Ç®„Ç≥„Éê„ÉÉ„Ç∞", correct: true, emoji: "üõçÔ∏è" },
                right: { text: "„É¨„Ç∏Ë¢ã", correct: false, emoji: "üõí" }
            },
            {
                question: "ÈõªÊ∞ó„ÄÅ„Å©„Å£„Å°„ÅåÂú∞ÁêÉ„Å´„ÇÑ„Åï„Åó„ÅÑÔºü",
                left: { text: "Â§™ÈôΩÂÖâÁô∫Èõª", correct: true, emoji: "‚òÄÔ∏è" },
                right: { text: "ÁÅ´ÂäõÁô∫Èõª", correct: false, emoji: "üè≠" }
            },
            {
                question: "È£≤„ÅøÁâ©„ÄÅ„Å©„Å£„Å°„Åå„Ç®„Ç≥Ôºü",
                left: { text: "„Éû„Ç§„Éú„Éà„É´", correct: true, emoji: "üç∂" },
                right: { text: "„Éö„ÉÉ„Éà„Éú„Éà„É´", correct: false, emoji: "ü•§" }
            },
            {
                question: "ÁßªÂãï„ÄÅ„Å©„Å£„Å°„ÅåÁí∞Â¢É„Å´„ÅÑ„ÅÑÔºü",
                left: { text: "Ëá™Ëª¢Ëªä", correct: true, emoji: "üö≤" },
                right: { text: "Ëá™ÂãïËªä", correct: false, emoji: "üöó" }
            },
            {
                question: "„Ç¥„Éü„ÄÅ„Å©„Å£„Å°„ÅåÂ§ßÂàáÔºü",
                left: { text: "„É™„Çµ„Ç§„ÇØ„É´", correct: true, emoji: "‚ôªÔ∏è" },
                right: { text: "„Åù„ÅÆ„Åæ„ÅæÊç®„Å¶„Çã", correct: false, emoji: "üóëÔ∏è" }
            }
        ];
        
        let currentQuiz = 0;
        let score = 0;
        let canAnswer = false;
        let leftTimer = null;
        let rightTimer = null;
        let leftCount = 0;
        let rightCount = 0;
        const HOLD_TIME = 2; // 2Áßí
        let faceMesh = null;
        let isFaceMode = false;
        let restartTimer = null;
        let restartCount = 0;
        
        // UIË¶ÅÁ¥†
        const questionEl = document.getElementById('question');
        const choiceLeftEl = document.getElementById('choice-left');
        const choiceRightEl = document.getElementById('choice-right');
        const scoreEl = document.getElementById('score');

        const countdownEl = document.getElementById('countdown');
        
        // „ÇØ„Ç§„Ç∫Ë°®Á§∫
        function displayQuiz() {
            if (currentQuiz >= quizData.length) {
                showResult();
                return;
            }
            
            const quiz = quizData[currentQuiz];
            questionEl.textContent = quiz.question;
            choiceLeftEl.innerHTML = `${quiz.left.emoji}<br>${quiz.left.text}`;
            choiceRightEl.innerHTML = `${quiz.right.emoji}<br>${quiz.right.text}`;
            
            canAnswer = true;
        }
        
        // Ê≠£Ëß£Âá¶ÁêÜ
        function answerQuiz(isLeft) {
            if (!canAnswer) return;
            canAnswer = false;
            
            const quiz = quizData[currentQuiz];
            const isCorrect = (isLeft && quiz.left.correct) || (!isLeft && quiz.right.correct);
            
            const choiceEl = isLeft ? choiceLeftEl : choiceRightEl;
            
            if (isCorrect) {
                score++;
                scoreEl.textContent = `„Çπ„Ç≥„Ç¢: ${score}/5`;
                
                // Ê≠£Ëß£„Ç®„Éï„Çß„ÇØ„Éà
                choiceEl.classList.add('correct');
                createParticles();
                
                setTimeout(() => {
                    choiceEl.classList.remove('correct');
                    currentQuiz++;
                    displayQuiz();
                }, 1500);
            } else {
                // ‰∏çÊ≠£Ëß£„Ç®„Éï„Çß„ÇØ„Éà
                choiceEl.classList.add('wrong');
                
                setTimeout(() => {
                    choiceEl.classList.remove('wrong');
                    currentQuiz++;
                    displayQuiz();
                }, 1000);
            }
        }
        
        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁîüÊàê
        function createParticles() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 0.5 + 's';
                    document.getElementById('quiz-overlay').appendChild(particle);
                    
                    setTimeout(() => particle.remove(), 2000);
                }, i * 20);
            }
        }
        
        // ÁµêÊûúË°®Á§∫
        function showResult() {
            // „ÇØ„Ç§„Ç∫ÁµÇ‰∫Ü„ÄÅ„Åô„Åê„Å´È°îÊ§úÂá∫„É¢„Éº„Éâ
            questionEl.textContent = 'üéâ „ÇØ„É™„Ç¢ÔºÅ';
            choiceLeftEl.style.display = 'none';
            choiceRightEl.style.display = 'none';
            
            if (score === 5) {
                createParticles();
                createParticles();
            }
            
            // È°îÊ§úÂá∫„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
            setTimeout(() => {
                isFaceMode = true;
                initFaceDetection();
            }, 1000);
        }
        

        

        
        // MediaPipe Hands
        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                for (const landmarks of results.multiHandLandmarks) {
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
                    drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});
                    
                    // „ÇØ„Ç§„Ç∫„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøÂà§ÂÆöÂá¶ÁêÜ
                    if (!isFaceMode) {
                    const canvasRect = canvasElement.getBoundingClientRect();
                    const leftRect = choiceLeftEl.getBoundingClientRect();
                    const rightRect = choiceRightEl.getBoundingClientRect();
                    
                    let leftHit = false;
                    let rightHit = false;
                    
                    const checkPoints = [0, 4, 8, 12, 16, 20];
                    
                    for (const pointIndex of checkPoints) {
                        const point = landmarks[pointIndex];
                        const fingerPos = {
                            x: (1 - point.x) * canvasRect.width,
                            y: point.y * canvasRect.height
                        };
                        
                        if (fingerPos.x >= leftRect.left && fingerPos.x <= leftRect.right &&
                            fingerPos.y >= leftRect.top && fingerPos.y <= leftRect.bottom) {
                            leftHit = true;
                        }
                        
                        if (fingerPos.x >= rightRect.left && fingerPos.x <= rightRect.right &&
                            fingerPos.y >= rightRect.top && fingerPos.y <= rightRect.bottom) {
                            rightHit = true;
                        }
                    }
                    
                    // Â∑¶„ÅÆÈÅ∏ÊäûËÇ¢
                    if (leftHit && canAnswer) {
                        choiceLeftEl.classList.add('hover');
                        if (!leftTimer) {
                            leftCount = 0;
                            leftTimer = setInterval(() => {
                                leftCount++;
                                const remaining = HOLD_TIME - leftCount;
                                countdownEl.textContent = remaining;
                                countdownEl.style.display = 'block';
                                
                                if (leftCount >= HOLD_TIME) {
                                    clearInterval(leftTimer);
                                    leftTimer = null;
                                    countdownEl.style.display = 'none';
                                    answerQuiz(true);
                                }
                            }, 1000);
                        }
                    } else if (!leftTimer) {
                        choiceLeftEl.classList.remove('hover');
                    }
                    
                    if (leftTimer && !leftHit) {
                        clearInterval(leftTimer);
                        leftTimer = null;
                        leftCount = 0;
                        countdownEl.style.display = 'none';
                        choiceLeftEl.classList.remove('hover');
                    }
                    
                    // Âè≥„ÅÆÈÅ∏ÊäûËÇ¢
                    if (rightHit && canAnswer) {
                        choiceRightEl.classList.add('hover');
                        if (!rightTimer) {
                            rightCount = 0;
                            rightTimer = setInterval(() => {
                                rightCount++;
                                const remaining = HOLD_TIME - rightCount;
                                countdownEl.textContent = remaining;
                                countdownEl.style.display = 'block';
                                
                                if (rightCount >= HOLD_TIME) {
                                    clearInterval(rightTimer);
                                    rightTimer = null;
                                    countdownEl.style.display = 'none';
                                    answerQuiz(false);
                                }
                            }, 1000);
                        }
                    } else if (!rightTimer) {
                        choiceRightEl.classList.remove('hover');
                    }
                    
                    if (rightTimer && !rightHit) {
                        clearInterval(rightTimer);
                        rightTimer = null;
                        rightCount = 0;
                        countdownEl.style.display = 'none';
                        choiceRightEl.classList.remove('hover');
                    }
                    }
                }
            }
            

            
            canvasCtx.restore();
        }
        
        // È°îÊ§úÂá∫ÂàùÊúüÂåñ
        function initFaceDetection() {
            faceMesh = new FaceMesh({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/${file}`;
                }
            });
            
            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            faceMesh.onResults(onFaceResults);
        }
        
        // È°îÊ§úÂá∫ÁµêÊûúÂá¶ÁêÜ
        function onFaceResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                for (const landmarks of results.multiFaceLandmarks) {
                    // È°î„ÅÆ„É©„É≥„Éâ„Éû„Éº„ÇØ„ÇíÊèèÁîª
                    drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, {color: '#C0C0C070', lineWidth: 1});
                    drawConnectors(canvasCtx, landmarks, FACEMESH_RIGHT_EYE, {color: '#FF3030'});
                    drawConnectors(canvasCtx, landmarks, FACEMESH_LEFT_EYE, {color: '#30FF30'});
                    drawConnectors(canvasCtx, landmarks, FACEMESH_FACE_OVAL, {color: '#E0E0E0'});
                    drawConnectors(canvasCtx, landmarks, FACEMESH_LIPS, {color: '#E0E0E0'});
                }
            }
            
            canvasCtx.restore();
        }
        

        
        const hands = new Hands({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.1.1617147326/${file}`;
            }
        });
        
        hands.setOptions({
            maxNumHands: 2,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.5
        });
        
        hands.onResults(onResults);
        
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                if (isFaceMode && faceMesh) {
                    await faceMesh.send({image: videoElement});
                } else {
                    await hands.send({image: videoElement});
                }
            },
            width: 1280,
            height: 720
        });
        
        camera.start().then(() => {
            displayQuiz();
        });
    </script>
</body>
</html>
