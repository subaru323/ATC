<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>ATC „Ç®„Ç≥„Éó„É©„Ç∂‰ΩìÈ®ì</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.2.1617146986/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.1.1617146909/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.1.1617147326/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/face_mesh.js" crossorigin="anonymous"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', '„É°„Ç§„É™„Ç™', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .input_video {
            display: none;
        }
        
        .output_canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scaleX(-1);
            max-width: 95vw;
            max-height: 95vh;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        #title {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            padding: 15px 40px;
            border-radius: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #333;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 5;
        }
        
        .menu-button {
            position: absolute;
            background: rgba(255,255,255,0.9);
            padding: 40px 60px;
            border-radius: 20px;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-width: 280px;
        }
        
        #btn-quiz {
            top: 50%;
            left: 15%;
            transform: translate(-50%, -50%);
        }
        
        #btn-photo {
            top: 12%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        #btn-learn {
            top: 50%;
            right: 15%;
            left: auto;
            transform: translate(50%, -50%);
        }
        
        .menu-button.hover {
            transform: translate(-50%, -50%) scale(1.1);
            background: rgba(144,238,144,0.95);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        #countdown {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 150px;
            font-weight: bold;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 0 30px rgba(0,0,0,0.8);
            display: none;
            z-index: 100;
        }
        
        /* Áü•„Çç„ÅÜÔºÅ„É¢„Éº„ÉâÁî® */
        #learn-screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        #learn-screen.active {
            pointer-events: auto;
        }
        
        .sdg-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80vw;
            height: 60vh;
            transform: translate(-50%, -50%);
        }
        
        .sdg-item {
            position: absolute;
            background: rgba(255,255,255,0.95);
            padding: 20px 30px;
            border-radius: 20px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            min-width: 200px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .sdg-item.hover {
            transform: scale(1.2);
            background: rgba(144,238,144,0.95);
            z-index: 10;
        }
        
        #learn-back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            pointer-events: auto;
            cursor: pointer;
            z-index: 20;
        }
        
        #learn-detail {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 40px 60px;
            border-radius: 30px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            display: none;
            z-index: 15;
        }
        
        #learn-detail h2 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        #learn-detail p {
            font-size: 20px;
            line-height: 1.8;
            color: #333;
        }
        
        #close-detail-btn {
            margin-top: 30px;
            padding: 15px 40px;
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
        }
        
        /* ÊíÆÂΩ±„É¢„Éº„ÉâÁî® */
        #photo-screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        #photo-screen.active {
            pointer-events: auto;
        }
        
        .effect-button {
            position: absolute;
            right: 30px;
            background: rgba(255,255,255,0.9);
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 24px;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            min-width: 100px;
            pointer-events: auto;
            cursor: pointer;
        }
        
        #effect-sunglasses { top: 20%; }
        #effect-cat-ears { top: 30%; }
        #effect-flower { top: 40%; }
        #effect-sparkle { top: 50%; }
        #effect-heart { top: 60%; }
        #effect-rainbow { top: 70%; }
        
        .effect-button.active {
            background: rgba(144,238,144,0.95);
            transform: scale(1.1);
        }
        
        .effect-button.hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        #capture-btn {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            padding: 20px 40px;
            border-radius: 20px;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            min-width: 200px;
            text-align: center;
            pointer-events: auto;
            cursor: pointer;
        }
        
        #back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            pointer-events: auto;
            cursor: pointer;
        }
        
        #question {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            padding: 20px 30px;
            border-radius: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #333;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 90%;
        }
        
        .choice-box {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            padding: 60px 80px;
            border-radius: 20px;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-width: 350px;
        }
        
        #choice-left {
            left: 10%;
        }
        
        #choice-right {
            right: 10%;
        }
        
        .choice-box.hover {
            transform: translateY(-50%) scale(1.1);
            background: rgba(144,238,144,0.95);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .choice-box.correct {
            animation: correctAnim 0.5s;
        }
        
        .choice-box.wrong {
            animation: wrongAnim 0.5s;
            background: rgba(255,100,100,0.95) !important;
        }
        
        @keyframes correctAnim {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.2); }
        }
        
        @keyframes wrongAnim {
            0%, 100% { transform: translateY(-50%) translateX(0); }
            25% { transform: translateY(-50%) translateX(-10px); }
            75% { transform: translateY(-50%) translateX(10px); }
        }
        
        #score {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        /* „ÇØ„Ç§„Ç∫ÁîªÈù¢Áî® */
        #quiz-screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            pointer-events: none;
            animation: particleFall 2s linear;
        }
        
        @keyframes particleFall {
            from {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            to {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <video class="input_video"></video>
        <canvas class="output_canvas" width="1280" height="720"></canvas>
        
        <!-- „Éõ„Éº„É†ÁîªÈù¢ -->
        <div id="ui-overlay">
            <div id="title">ATC„Ç®„Ç≥„Éó„É©„Ç∂‰ΩìÈ®ì</div>
            <div id="btn-quiz" class="menu-button">üéÆ „ÇØ„Ç§„Ç∫</div>
            <div id="btn-photo" class="menu-button">üì∑ ÊíÆÂΩ±</div>
            <div id="btn-learn" class="menu-button">üìö Áü•„Çç„ÅÜÔºÅ</div>
        </div>
        
        <!-- „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ÔºàÂÖ®„É¢„Éº„ÉâÂÖ±ÈÄöÔºâ -->
        <div id="countdown"></div>
        
        <!-- „ÇØ„Ç§„Ç∫ÁîªÈù¢ -->
        <div id="quiz-screen">
            <div id="question">„Ç´„É°„É©„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            <div id="choice-left" class="choice-box"></div>
            <div id="choice-right" class="choice-box"></div>
            <div id="score">„Çπ„Ç≥„Ç¢: 0/5</div>
        </div>
        
        <!-- Áü•„Çç„ÅÜÔºÅÁîªÈù¢ -->
        <div id="learn-screen">
            <div id="learn-back-btn" class="menu-button">‚¨ÖÔ∏è Êàª„Çã</div>
            <div class="sdg-circle" id="sdg-circle">
                <div class="sdg-item" data-sdg="12">üåç SDG12<br>„Å§„Åè„ÇãË≤¨‰ªª</div>
                <div class="sdg-item" data-sdg="7">‚ö° SDG7<br>„ÇØ„É™„Éº„É≥„Ç®„Éç„É´„ÇÆ„Éº</div>
                <div class="sdg-item" data-sdg="13">üå°Ô∏è SDG13<br>Ê∞óÂÄôÂ§âÂãïÂØæÁ≠ñ</div>
                <div class="sdg-item" data-sdg="14">üê† SDG14<br>Êµ∑„ÅÆË±ä„Åã„Åï</div>
                <div class="sdg-item" data-sdg="15">üå≥ SDG15<br>Èô∏„ÅÆË±ä„Åã„Åï</div>
            </div>
            <div id="learn-detail">
                <h2 id="detail-title"></h2>
                <p id="detail-content"></p>
                <button id="close-detail-btn">Êàª„Çã</button>
            </div>
        </div>
        
        <!-- ÊíÆÂΩ±ÁîªÈù¢ -->
        <div id="photo-screen">
            <div id="back-btn" class="menu-button">‚¨ÖÔ∏è Êàª„Çã</div>
            <div id="effect-sunglasses" class="effect-button">üòé „Çµ„É≥„Ç∞„É©„Çπ</div>
            <div id="effect-cat-ears" class="effect-button">üò∫ Áå´ËÄ≥</div>
            <div id="effect-flower" class="effect-button">üå∏ Ëä±ÂÜ†</div>
            <div id="effect-sparkle" class="effect-button">‚ú® „Ç≠„É©„Ç≠„É©</div>
            <div id="effect-heart" class="effect-button">üíï „Éè„Éº„Éà</div>
            <div id="effect-rainbow" class="effect-button">üåà Ëôπ</div>
            <div id="capture-btn" class="menu-button">üì∑ ÊíÆÂΩ±</div>
        </div>
    </div>

    <script type="module">
        const videoElement = document.querySelector('.input_video');
        const canvasElement = document.querySelector('.output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        
        // „É¢„Éº„ÉâÁÆ°ÁêÜ
        let currentMode = 'home'; // home, quiz, photo, learn
        
        // UIË¶ÅÁ¥†
        const uiOverlay = document.getElementById('ui-overlay');
        const quizScreen = document.getElementById('quiz-screen');
        const photoScreen = document.getElementById('photo-screen');
        const btnQuiz = document.getElementById('btn-quiz');
        const btnPhoto = document.getElementById('btn-photo');
        const btnLearn = document.getElementById('btn-learn');
        const countdownEl = document.getElementById('countdown');
        
        // Áü•„Çç„ÅÜÔºÅ„É¢„Éº„ÉâË¶ÅÁ¥†
        const learnScreen = document.getElementById('learn-screen');
        const learnBackBtn = document.getElementById('learn-back-btn');
        const sdgCircle = document.getElementById('sdg-circle');
        const sdgItems = document.querySelectorAll('.sdg-item');
        const learnDetail = document.getElementById('learn-detail');
        const detailTitle = document.getElementById('detail-title');
        const detailContent = document.getElementById('detail-content');
        const closeDetailBtn = document.getElementById('close-detail-btn');
        
        let rotationAngle = 0;
        let isRotating = true;
        let rotationInterval = null;
        let selectedSDG = null;
        let selectTimer = null;
        let selectCount = 0;
        const backBtn = document.getElementById('back-btn');
        const captureBtn = document.getElementById('capture-btn');
        const effectButtons = {
            sunglasses: document.getElementById('effect-sunglasses'),
            catEars: document.getElementById('effect-cat-ears'),
            flower: document.getElementById('effect-flower'),
            sparkle: document.getElementById('effect-sparkle'),
            heart: document.getElementById('effect-heart'),
            rainbow: document.getElementById('effect-rainbow')
        };
        
        let activeEffect = null;
        let captureTimer = null;
        let captureCount = 0;
        let captureStartTimer = null;
        let captureStartCount = 0;
        let isCapturing = false;
        const CAPTURE_TIME = 10;
        
        // „ÇØ„Ç§„Ç∫Áî®
        const questionEl = document.getElementById('question');
        const choiceLeftEl = document.getElementById('choice-left');
        const choiceRightEl = document.getElementById('choice-right');
        const scoreEl = document.getElementById('score');
        
        // „ÇØ„Ç§„Ç∫„Éá„Éº„Çø
        const quizData = [
            {
                question: "„ÅäË≤∑„ÅÑÁâ©„ÄÅ„Å©„Å£„Å°„Åå„Ç®„Ç≥Ôºü",
                left: { text: "„Ç®„Ç≥„Éê„ÉÉ„Ç∞", correct: true, emoji: "üõçÔ∏è" },
                right: { text: "„É¨„Ç∏Ë¢ã", correct: false, emoji: "üõí" }
            },
            {
                question: "ÈõªÊ∞ó„ÄÅ„Å©„Å£„Å°„ÅåÂú∞ÁêÉ„Å´„ÇÑ„Åï„Åó„ÅÑÔºü",
                left: { text: "Â§™ÈôΩÂÖâÁô∫Èõª", correct: true, emoji: "‚òÄÔ∏è" },
                right: { text: "ÁÅ´ÂäõÁô∫Èõª", correct: false, emoji: "üè≠" }
            },
            {
                question: "È£≤„ÅøÁâ©„ÄÅ„Å©„Å£„Å°„Åå„Ç®„Ç≥Ôºü",
                left: { text: "„Éû„Ç§„Éú„Éà„É´", correct: true, emoji: "üç∂" },
                right: { text: "„Éö„ÉÉ„Éà„Éú„Éà„É´", correct: false, emoji: "ü•§" }
            },
            {
                question: "ÁßªÂãï„ÄÅ„Å©„Å£„Å°„ÅåÁí∞Â¢É„Å´„ÅÑ„ÅÑÔºü",
                left: { text: "Ëá™Ëª¢Ëªä", correct: true, emoji: "üö≤" },
                right: { text: "Ëá™ÂãïËªä", correct: false, emoji: "üöó" }
            },
            {
                question: "„Ç¥„Éü„ÄÅ„Å©„Å£„Å°„ÅåÂ§ßÂàáÔºü",
                left: { text: "„É™„Çµ„Ç§„ÇØ„É´", correct: true, emoji: "‚ôªÔ∏è" },
                right: { text: "„Åù„ÅÆ„Åæ„ÅæÊç®„Å¶„Çã", correct: false, emoji: "üóëÔ∏è" }
            }
        ];
        
        // SDGs„Éá„Éº„Çø
        const sdgData = {
            12: {
                title: "SDG12: „Å§„Åè„ÇãË≤¨‰ªª „Å§„Åã„ÅÜË≤¨‰ªª",
                content: "ATC„Ç∞„É™„Éº„É≥„Ç®„Ç≥„Éó„É©„Ç∂„Åß„ÅØ„ÄÅÊåÅÁ∂öÂèØËÉΩ„Å™ÁîüÁî£„Å®Ê∂àË≤ª„ÇíÊé®ÈÄ≤„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÁí∞Â¢É„Å´ÂÑ™„Åó„ÅÑË£ΩÂìÅ„ÇÑ„É™„Çµ„Ç§„ÇØ„É´Á¥†Êùê„Çí‰ΩøÁî®„Åó„ÅüÂïÜÂìÅ„ÇíÂ±ïÁ§∫„Åó„ÄÅË®™„Çå„Çã‰∫∫„ÄÖ„Å´„ÄåË≤¨‰ªª„ÅÇ„ÇãÊ∂àË≤ª„Äç„ÅÆÂ§ßÂàá„Åï„Çí‰ºù„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åî„Åø„ÇíÊ∏õ„Çâ„Åó„ÄÅË≥áÊ∫ê„ÇíÂ§ßÂàá„Å´‰Ωø„ÅÜ„Åì„Å®„ÅåÊú™Êù•„ÅÆÂú∞ÁêÉ„ÇíÂÆà„Çä„Åæ„Åô„ÄÇ"
            },
            7: {
                title: "SDG7: „Ç®„Éç„É´„ÇÆ„Éº„Çí„Åø„Çì„Å™„Å´ „Åù„Åó„Å¶„ÇØ„É™„Éº„É≥„Å´",
                content: "Â§™ÈôΩÂÖâÁô∫Èõª„ÇÑÈ¢®ÂäõÁô∫Èõª„Å™„Å©„ÅÆÂÜçÁîüÂèØËÉΩ„Ç®„Éç„É´„ÇÆ„Éº„ÇíÁ¥π‰ªã„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Ç®„Ç≥„Éó„É©„Ç∂„Åß„ÅØ„ÄÅ„ÇØ„É™„Éº„É≥„Ç®„Éç„É´„ÇÆ„Éº„Çí‰ΩøÁî®„Åó„ÅüË£ΩÂìÅ„ÇÑ„ÄÅÁúÅ„Ç®„ÉçÊäÄË°ì„ÅÆÂ±ïÁ§∫„ÇíÈÄö„Åò„Å¶„ÄÅÊåÅÁ∂öÂèØËÉΩ„Å™„Ç®„Éç„É´„ÇÆ„ÉºÁ§æ‰ºö„ÅÆÂÆüÁèæ„ÇíÁõÆÊåá„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ"
            },
            13: {
                title: "SDG13: Ê∞óÂÄôÂ§âÂãï„Å´ÂÖ∑‰ΩìÁöÑ„Å™ÂØæÁ≠ñ„Çí",
                content: "Âú∞ÁêÉÊ∏©ÊöñÂåñ„ÇíÈò≤„Åé„ÄÅÊ∞óÂÄôÂ§âÂãï„ÅÆÂΩ±Èüø„ÇíÊ∏õ„Çâ„Åô„Åü„ÇÅ„ÅÆÂèñ„ÇäÁµÑ„Åø„ÇíÁ¥π‰ªã„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇCO2ÂâäÊ∏õ„ÅÆÈáçË¶ÅÊÄß„ÇÑ„ÄÅÊó•Â∏∏ÁîüÊ¥ª„Åß„Åß„Åç„ÇãÁØÄÈõª„ÉªÁØÄÊ∞¥„Å™„Å©„ÅÆÂÖ∑‰ΩìÁöÑ„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂ≠¶„Å∂„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ"
            },
            14: {
                title: "SDG14: Êµ∑„ÅÆË±ä„Åã„Åï„ÇíÂÆà„Çç„ÅÜ",
                content: "Êµ∑Ê¥ã„Éó„É©„Çπ„ÉÅ„ÉÉ„ÇØÂïèÈ°å„ÇÑÊµ∑Ê¥ãÊ±öÊüì„ÅÆÊ∑±Âàª„Åï„Çí‰ºù„Åà„ÄÅÊµ∑„ÇíÂÆà„Çã„Åü„ÇÅ„ÅÆË°åÂãï„ÇíÊèêÊ°à„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÂ§ßÈò™Êπæ„Å´Èù¢„Åó„ÅüATC„Åß„ÅØ„ÄÅÂú∞Âüü„ÅÆÊµ∑„ÇíÂÆà„ÇãÂèñ„ÇäÁµÑ„Åø„ÇÑ„ÄÅ„Éó„É©„Çπ„ÉÅ„ÉÉ„ÇØ‰ª£ÊõøÂìÅ„ÅÆ‰ΩøÁî®„ÇíÊé®ÈÄ≤„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ"
            },
            15: {
                title: "SDG15: Èô∏„ÅÆË±ä„Åã„Åï„ÇÇÂÆà„Çç„ÅÜ",
                content: "Ê£ÆÊûó‰øùË≠∑„ÄÅÁîüÁâ©Â§öÊßòÊÄß„ÅÆ‰øùÂÖ®„ÄÅÁ∑ëÂåñÊé®ÈÄ≤„Å™„Å©„ÄÅÈô∏„ÅÆË±ä„Åã„Åï„ÇíÂÆà„ÇãÂèñ„ÇäÁµÑ„Åø„ÇíÁ¥π‰ªã„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÊú®ÊùêË™çË®ºÂà∂Â∫¶„ÇÑ„Ç®„Ç≥„Éû„Éº„ÇØ‰ªò„ÅçË£ΩÂìÅ„Å™„Å©„ÄÅÁí∞Â¢É„Å´ÂÑ™„Åó„ÅÑÈÅ∏Êäû„ÇíÂ≠¶„Å∂„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ"
            }
        };
        let score = 0;
        let canAnswer = false;
        let leftTimer = null;
        let rightTimer = null;
        let leftCount = 0;
        let rightCount = 0;
        const HOLD_TIME = 2;
        let faceMesh = null;
        
        // „Éõ„Éº„É†„Éú„Çø„É≥„Çø„Ç§„Éû„Éº
        let btnTimers = {
            quiz: null,
            photo: null,
            learn: null
        };
        let btnCounts = {
            quiz: 0,
            photo: 0,
            learn: 0
        };
        
        // „É¢„Éº„ÉâÂàáÊõø
        function switchMode(mode) {
            currentMode = mode;
            
            if (mode === 'home') {
                uiOverlay.style.display = 'block';
                quizScreen.style.display = 'none';
                photoScreen.style.display = 'none';
                photoScreen.classList.remove('active');
                learnScreen.style.display = 'none';
                learnScreen.classList.remove('active');
                stopRotation();
            } else if (mode === 'quiz') {
                uiOverlay.style.display = 'none';
                quizScreen.style.display = 'block';
                photoScreen.style.display = 'none';
                photoScreen.classList.remove('active');
                learnScreen.style.display = 'none';
                learnScreen.classList.remove('active');
                currentQuiz = 0;
                score = 0;
                scoreEl.textContent = '„Çπ„Ç≥„Ç¢: 0/5';
                displayQuiz();
            } else if (mode === 'photo') {
                uiOverlay.style.display = 'none';
                quizScreen.style.display = 'none';
                photoScreen.style.display = 'block';
                photoScreen.classList.add('active');
                learnScreen.style.display = 'none';
                learnScreen.classList.remove('active');
                activeEffect = null;
                initFaceDetection();
            } else if (mode === 'learn') {
                uiOverlay.style.display = 'none';
                quizScreen.style.display = 'none';
                photoScreen.style.display = 'none';
                photoScreen.classList.remove('active');
                learnScreen.style.display = 'block';
                learnScreen.classList.add('active');
                learnDetail.style.display = 'none';
                initSDGCircle();
                startRotation();
            }
        }
        
        // SDGÈ†ÖÁõÆ„ÇíÂÜÜÂΩ¢„Å´ÈÖçÁΩÆ
        function initSDGCircle() {
            const items = Array.from(sdgItems);
            const count = items.length;
            const radiusX = sdgCircle.offsetWidth / 2 - 100;
            const radiusY = sdgCircle.offsetHeight / 2 - 50;
            
            items.forEach((item, index) => {
                const angle = (Math.PI * 2 * index) / count;
                const x = Math.cos(angle) * radiusX;
                const y = Math.sin(angle) * radiusY;
                
                item.style.left = `calc(50% + ${x}px)`;
                item.style.top = `calc(50% + ${y}px)`;
                item.style.transform = 'translate(-50%, -50%)';
            });
        }
        
        // ÂõûËª¢ÈñãÂßã
        function startRotation() {
            isRotating = true;
            rotationAngle = 0;
            if (rotationInterval) clearInterval(rotationInterval);
            
            rotationInterval = setInterval(() => {
                if (isRotating) {
                    rotationAngle += 0.5;
                    updateSDGPositions();
                }
            }, 30);
        }
        
        // ÂõûËª¢ÂÅúÊ≠¢
        function stopRotation() {
            if (rotationInterval) {
                clearInterval(rotationInterval);
                rotationInterval = null;
            }
            isRotating = false;
        }
        
        // SDG‰ΩçÁΩÆÊõ¥Êñ∞
        function updateSDGPositions() {
            const items = Array.from(sdgItems);
            const count = items.length;
            const radiusX = sdgCircle.offsetWidth / 2 - 100;
            const radiusY = sdgCircle.offsetHeight / 2 - 50;
            
            items.forEach((item, index) => {
                const baseAngle = (Math.PI * 2 * index) / count;
                const angle = baseAngle + (rotationAngle * Math.PI / 180);
                const x = Math.cos(angle) * radiusX;
                const y = Math.sin(angle) * radiusY;
                
                item.style.left = `calc(50% + ${x}px)`;
                item.style.top = `calc(50% + ${y}px)`;
            });
        }
        function checkHomeButtons(landmarks) {
            if (currentMode !== 'home') return;
            
            const canvasRect = canvasElement.getBoundingClientRect();
            const quizRect = btnQuiz.getBoundingClientRect();
            const photoRect = btnPhoto.getBoundingClientRect();
            const learnRect = btnLearn.getBoundingClientRect();
            
            const checkPoints = [0, 4, 8, 12, 16, 20];
            let quizHit = false;
            let photoHit = false;
            let learnHit = false;
            
            for (const pointIndex of checkPoints) {
                const point = landmarks[pointIndex];
                const fingerPos = {
                    x: canvasRect.left + (1 - point.x) * canvasRect.width,
                    y: canvasRect.top + point.y * canvasRect.height
                };
                
                if (fingerPos.x >= quizRect.left && fingerPos.x <= quizRect.right &&
                    fingerPos.y >= quizRect.top && fingerPos.y <= quizRect.bottom) {
                    quizHit = true;
                }
                
                if (fingerPos.x >= photoRect.left && fingerPos.x <= photoRect.right &&
                    fingerPos.y >= photoRect.top && fingerPos.y <= photoRect.bottom) {
                    photoHit = true;
                }
                
                if (fingerPos.x >= learnRect.left && fingerPos.x <= learnRect.right &&
                    fingerPos.y >= learnRect.top && fingerPos.y <= learnRect.bottom) {
                    learnHit = true;
                }
            }
            
            // „ÇØ„Ç§„Ç∫„Éú„Çø„É≥
            if (quizHit) {
                btnQuiz.classList.add('hover');
                if (!btnTimers.quiz) {
                    btnCounts.quiz = 0;
                    btnTimers.quiz = setInterval(() => {
                        btnCounts.quiz++;
                        const remaining = HOLD_TIME - btnCounts.quiz;
                        countdownEl.textContent = remaining;
                        countdownEl.style.display = 'block';
                        
                        if (btnCounts.quiz >= HOLD_TIME) {
                            clearInterval(btnTimers.quiz);
                            btnTimers.quiz = null;
                            countdownEl.style.display = 'none';
                            switchMode('quiz');
                        }
                    }, 1000);
                }
            } else {
                btnQuiz.classList.remove('hover');
                if (btnTimers.quiz) {
                    clearInterval(btnTimers.quiz);
                    btnTimers.quiz = null;
                    btnCounts.quiz = 0;
                    countdownEl.style.display = 'none';
                }
            }
            
            // ÊíÆÂΩ±„Éú„Çø„É≥
            if (photoHit) {
                btnPhoto.classList.add('hover');
                if (!btnTimers.photo) {
                    btnCounts.photo = 0;
                    btnTimers.photo = setInterval(() => {
                        btnCounts.photo++;
                        const remaining = HOLD_TIME - btnCounts.photo;
                        countdownEl.textContent = remaining;
                        countdownEl.style.display = 'block';
                        
                        if (btnCounts.photo >= HOLD_TIME) {
                            clearInterval(btnTimers.photo);
                            btnTimers.photo = null;
                            countdownEl.style.display = 'none';
                            switchMode('photo');
                        }
                    }, 1000);
                }
            } else {
                btnPhoto.classList.remove('hover');
                if (btnTimers.photo) {
                    clearInterval(btnTimers.photo);
                    btnTimers.photo = null;
                    btnCounts.photo = 0;
                    countdownEl.style.display = 'none';
                }
            }
            
            // Áü•„Çç„ÅÜÔºÅ„Éú„Çø„É≥
            if (learnHit) {
                btnLearn.classList.add('hover');
                if (!btnTimers.learn) {
                    btnCounts.learn = 0;
                    btnTimers.learn = setInterval(() => {
                        btnCounts.learn++;
                        const remaining = HOLD_TIME - btnCounts.learn;
                        countdownEl.textContent = remaining;
                        countdownEl.style.display = 'block';
                        
                        if (btnCounts.learn >= HOLD_TIME) {
                            clearInterval(btnTimers.learn);
                            btnTimers.learn = null;
                            countdownEl.style.display = 'none';
                            switchMode('learn');
                        }
                    }, 1000);
                }
            } else {
                btnLearn.classList.remove('hover');
                if (btnTimers.learn) {
                    clearInterval(btnTimers.learn);
                    btnTimers.learn = null;
                    btnCounts.learn = 0;
                    countdownEl.style.display = 'none';
                }
            }
        }
        
        // „ÇØ„Ç§„Ç∫Ë°®Á§∫
        function displayQuiz() {
            if (currentQuiz >= quizData.length) {
                showResult();
                return;
            }
            
            const quiz = quizData[currentQuiz];
            questionEl.textContent = quiz.question;
            choiceLeftEl.innerHTML = `${quiz.left.emoji}<br>${quiz.left.text}`;
            choiceRightEl.innerHTML = `${quiz.right.emoji}<br>${quiz.right.text}`;
            
            canAnswer = true;
        }
        
        // Ê≠£Ëß£Âá¶ÁêÜ
        function answerQuiz(isLeft) {
            if (!canAnswer) return;
            canAnswer = false;
            
            const quiz = quizData[currentQuiz];
            const isCorrect = (isLeft && quiz.left.correct) || (!isLeft && quiz.right.correct);
            
            const choiceEl = isLeft ? choiceLeftEl : choiceRightEl;
            
            if (isCorrect) {
                score++;
                scoreEl.textContent = `„Çπ„Ç≥„Ç¢: ${score}/5`;
                
                choiceEl.classList.add('correct');
                createParticles();
                
                setTimeout(() => {
                    choiceEl.classList.remove('correct');
                    currentQuiz++;
                    displayQuiz();
                }, 1500);
            } else {
                choiceEl.classList.add('wrong');
                
                setTimeout(() => {
                    choiceEl.classList.remove('wrong');
                    currentQuiz++;
                    displayQuiz();
                }, 1000);
            }
        }
        
        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁîüÊàê
        function createParticles() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 0.5 + 's';
                    document.getElementById('ui-overlay').appendChild(particle);
                    
                    setTimeout(() => particle.remove(), 2000);
                }, i * 20);
            }
        }
        
        // ÁµêÊûúË°®Á§∫
        function showResult() {
            questionEl.textContent = 'üéâ „ÇØ„É™„Ç¢ÔºÅ';
            choiceLeftEl.style.display = 'none';
            choiceRightEl.style.display = 'none';
            
            if (score === 5) {
                createParticles();
                createParticles();
            }
            
            setTimeout(() => {
                initFaceDetection();
            }, 1000);
            
            setTimeout(() => {
                switchMode('home');
                choiceLeftEl.style.display = 'block';
                choiceRightEl.style.display = 'block';
            }, 5000);
        }
        
        // MediaPipe Hands
        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                for (const landmarks of results.multiHandLandmarks) {
                    // ÊíÆÂΩ±„É¢„Éº„Éâ‰ª•Â§ñ„ÅØÊâã„ÅÆÊ§úÂá∫„ÇíË°®Á§∫
                    if (currentMode !== 'photo') {
                        drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
                        drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});
                    }
                    
                    // „Éõ„Éº„É†ÁîªÈù¢
                    if (currentMode === 'home') {
                        checkHomeButtons(landmarks);
                    }
                    
                    // „ÇØ„Ç§„Ç∫„É¢„Éº„Éâ
                    if (currentMode === 'quiz') {
                        const canvasRect = canvasElement.getBoundingClientRect();
                        const leftRect = choiceLeftEl.getBoundingClientRect();
                        const rightRect = choiceRightEl.getBoundingClientRect();
                        
                        let leftHit = false;
                        let rightHit = false;
                        
                        const checkPoints = [0, 4, 8, 12, 16, 20];
                        
                        for (const pointIndex of checkPoints) {
                            const point = landmarks[pointIndex];
                            const fingerPos = {
                                x: canvasRect.left + (1 - point.x) * canvasRect.width,
                                y: canvasRect.top + point.y * canvasRect.height
                            };
                            
                            if (fingerPos.x >= leftRect.left && fingerPos.x <= leftRect.right &&
                                fingerPos.y >= leftRect.top && fingerPos.y <= leftRect.bottom) {
                                leftHit = true;
                            }
                            
                            if (fingerPos.x >= rightRect.left && fingerPos.x <= rightRect.right &&
                                fingerPos.y >= rightRect.top && fingerPos.y <= rightRect.bottom) {
                                rightHit = true;
                            }
                        }
                        
                        // Â∑¶„ÅÆÈÅ∏ÊäûËÇ¢
                        if (leftHit && canAnswer) {
                            choiceLeftEl.classList.add('hover');
                            if (!leftTimer) {
                                leftCount = 0;
                                leftTimer = setInterval(() => {
                                    leftCount++;
                                    const remaining = HOLD_TIME - leftCount;
                                    countdownEl.textContent = remaining;
                                    countdownEl.style.display = 'block';
                                    
                                    if (leftCount >= HOLD_TIME) {
                                        clearInterval(leftTimer);
                                        leftTimer = null;
                                        countdownEl.style.display = 'none';
                                        answerQuiz(true);
                                    }
                                }, 1000);
                            }
                        } else if (!leftTimer) {
                            choiceLeftEl.classList.remove('hover');
                        }
                        
                        if (leftTimer && !leftHit) {
                            clearInterval(leftTimer);
                            leftTimer = null;
                            leftCount = 0;
                            countdownEl.style.display = 'none';
                            choiceLeftEl.classList.remove('hover');
                        }
                        
                        // Âè≥„ÅÆÈÅ∏ÊäûËÇ¢
                        if (rightHit && canAnswer) {
                            choiceRightEl.classList.add('hover');
                            if (!rightTimer) {
                                rightCount = 0;
                                rightTimer = setInterval(() => {
                                    rightCount++;
                                    const remaining = HOLD_TIME - rightCount;
                                    countdownEl.textContent = remaining;
                                    countdownEl.style.display = 'block';
                                    
                                    if (rightCount >= HOLD_TIME) {
                                        clearInterval(rightTimer);
                                        rightTimer = null;
                                        countdownEl.style.display = 'none';
                                        answerQuiz(false);
                                    }
                                }, 1000);
                            }
                        } else if (!rightTimer) {
                            choiceRightEl.classList.remove('hover');
                        }
                        
                        if (rightTimer && !rightHit) {
                            clearInterval(rightTimer);
                            rightTimer = null;
                            rightCount = 0;
                            countdownEl.style.display = 'none';
                            choiceRightEl.classList.remove('hover');
                        }
                    }
                    
                    // Áü•„Çç„ÅÜÔºÅ„É¢„Éº„Éâ
                    if (currentMode === 'learn') {
                        checkSDGSelection(landmarks);
                    }
                }
            }
            
            canvasCtx.restore();
        }
        
        // SDGÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ
        function checkSDGSelection(landmarks) {
            const canvasRect = canvasElement.getBoundingClientRect();
            const checkPoints = [0, 4, 8, 12, 16, 20];
            
            let hitSDG = null;
            
            for (const pointIndex of checkPoints) {
                const point = landmarks[pointIndex];
                const fingerPos = {
                    x: canvasRect.left + (1 - point.x) * canvasRect.width,
                    y: canvasRect.top + point.y * canvasRect.height
                };
                
                // ÂêÑSDGÈ†ÖÁõÆ„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö
                for (const item of sdgItems) {
                    const rect = item.getBoundingClientRect();
                    if (fingerPos.x >= rect.left && fingerPos.x <= rect.right &&
                        fingerPos.y >= rect.top && fingerPos.y <= rect.bottom) {
                        hitSDG = item.getAttribute('data-sdg');
                        break;
                    }
                }
                
                if (hitSDG) break;
            }
            
            // „Éí„ÉÉ„Éà„Åó„ÅüÈ†ÖÁõÆ„ÅÆÂá¶ÁêÜ
            if (hitSDG) {
                // ÂõûËª¢ÂÅúÊ≠¢
                isRotating = false;
                
                // „Éõ„Éê„ÉºÂäπÊûú
                sdgItems.forEach(item => {
                    if (item.getAttribute('data-sdg') === hitSDG) {
                        item.classList.add('hover');
                    } else {
                        item.classList.remove('hover');
                    }
                });
                
                // 1Áßí„Éõ„Éº„É´„Éâ„ÅßÈÅ∏Êäû
                if (selectedSDG !== hitSDG) {
                    if (selectTimer) {
                        clearInterval(selectTimer);
                    }
                    selectedSDG = hitSDG;
                    selectCount = 0;
                    selectTimer = setInterval(() => {
                        selectCount++;
                        countdownEl.textContent = 1 - selectCount + 1;
                        countdownEl.style.display = 'block';
                        
                        if (selectCount >= 1) {
                            clearInterval(selectTimer);
                            selectTimer = null;
                            countdownEl.style.display = 'none';
                            showSDGDetail(hitSDG);
                        }
                    }, 1000);
                }
            } else {
                // „Éí„ÉÉ„Éà„Å™„Åó - ÂõûËª¢ÂÜçÈñã
                if (!isRotating && learnDetail.style.display !== 'block') {
                    isRotating = true;
                }
                
                sdgItems.forEach(item => item.classList.remove('hover'));
                
                if (selectTimer) {
                    clearInterval(selectTimer);
                    selectTimer = null;
                    selectCount = 0;
                    countdownEl.style.display = 'none';
                }
                
                selectedSDG = null;
            }
        }
        
        // SDGË©≥Á¥∞Ë°®Á§∫
        function showSDGDetail(sdgNum) {
            const data = sdgData[sdgNum];
            if (!data) return;
            
            detailTitle.textContent = data.title;
            detailContent.textContent = data.content;
            learnDetail.style.display = 'block';
            
            // Ë©≥Á¥∞Ë°®Á§∫‰∏≠„ÅØÂõûËª¢ÂÅúÊ≠¢
            isRotating = false;
        }
        
        // Áü•„Çç„ÅÜÔºÅÊàª„Çã„Éú„Çø„É≥
        learnBackBtn.addEventListener('click', () => {
            stopRotation();
            if (selectTimer) {
                clearInterval(selectTimer);
                selectTimer = null;
                countdownEl.style.display = 'none';
            }
            switchMode('home');
        });
        
        // Ë©≥Á¥∞Èñâ„Åò„Çã„Éú„Çø„É≥
        closeDetailBtn.addEventListener('click', () => {
            learnDetail.style.display = 'none';
            isRotating = true;
        });
        
        // ÊíÆÂΩ±„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
        captureBtn.addEventListener('click', () => {
            if (isCapturing) return;
            
            isCapturing = true;
            captureCount = 0;
            
            // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫
            countdownEl.textContent = CAPTURE_TIME;
            countdownEl.style.display = 'block';
            
            captureTimer = setInterval(() => {
                captureCount++;
                const remaining = CAPTURE_TIME - captureCount;
                countdownEl.textContent = remaining;
                
                if (captureCount >= CAPTURE_TIME) {
                    clearInterval(captureTimer);
                    captureTimer = null;
                    countdownEl.style.display = 'none';
                    isCapturing = false;
                    
                    const link = document.createElement('a');
                    link.download = 'atc-photo.png';
                    link.href = canvasElement.toDataURL();
                    link.click();
                }
            }, 1000);
        });
        
        // Êàª„Çã„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
        backBtn.addEventListener('click', () => {
            if (captureTimer) {
                clearInterval(captureTimer);
                captureTimer = null;
                countdownEl.style.display = 'none';
                isCapturing = false;
            }
            switchMode('home');
        });
        
        // „Ç®„Éï„Çß„ÇØ„Éà„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
        Object.entries(effectButtons).forEach(([key, btn]) => {
            btn.addEventListener('click', () => {
                Object.values(effectButtons).forEach(b => b.classList.remove('active'));
                if (activeEffect === key) {
                    activeEffect = null;
                } else {
                    activeEffect = key;
                    btn.classList.add('active');
                }
            });
        });

        function initFaceDetection() {
            if (faceMesh) return;
            
            faceMesh = new FaceMesh({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/${file}`;
                }
            });
            
            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            faceMesh.onResults(onFaceResults);
        }
        
        // È°îÊ§úÂá∫ÁµêÊûúÂá¶ÁêÜ
        function onFaceResults(results) {
            if (currentMode === 'quiz') {
                if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    for (const landmarks of results.multiFaceLandmarks) {
                        drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, {color: '#C0C0C070', lineWidth: 1});
                        drawConnectors(canvasCtx, landmarks, FACEMESH_RIGHT_EYE, {color: '#FF3030'});
                        drawConnectors(canvasCtx, landmarks, FACEMESH_LEFT_EYE, {color: '#30FF30'});
                        drawConnectors(canvasCtx, landmarks, FACEMESH_FACE_OVAL, {color: '#E0E0E0'});
                        drawConnectors(canvasCtx, landmarks, FACEMESH_LIPS, {color: '#E0E0E0'});
                    }
                }
            } else if (currentMode === 'photo' && activeEffect) {
                if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    const landmarks = results.multiFaceLandmarks[0];
                    drawEffect(landmarks);
                }
            }
        }
        
        // „Ç®„Éï„Çß„ÇØ„ÉàÊèèÁîª
        function drawEffect(landmarks) {
            const leftEye = landmarks[33];
            const rightEye = landmarks[263];
            const nose = landmarks[1];
            const forehead = landmarks[10];
            
            const canvasW = canvasElement.width;
            const canvasH = canvasElement.height;
            
            if (activeEffect === 'sunglasses') {
                const eyeDistance = Math.abs(rightEye.x - leftEye.x) * canvasW;
                const centerX = ((leftEye.x + rightEye.x) / 2) * canvasW;
                const centerY = (leftEye.y + rightEye.y) / 2 * canvasH;
                
                canvasCtx.fillStyle = '#000';
                canvasCtx.fillRect(centerX - eyeDistance * 0.7, centerY - 30, eyeDistance * 0.6, 50);
                canvasCtx.fillRect(centerX + eyeDistance * 0.1, centerY - 30, eyeDistance * 0.6, 50);
                canvasCtx.strokeStyle = '#000';
                canvasCtx.lineWidth = 5;
                canvasCtx.beginPath();
                canvasCtx.moveTo(centerX - eyeDistance * 0.7, centerY);
                canvasCtx.lineTo(centerX + eyeDistance * 0.7, centerY);
                canvasCtx.stroke();
            } else if (activeEffect === 'catEars') {
                const foreheadX = forehead.x * canvasW;
                const foreheadY = forehead.y * canvasH;
                
                canvasCtx.fillStyle = '#FFB6C1';
                canvasCtx.beginPath();
                canvasCtx.moveTo(foreheadX - 80, foreheadY - 20);
                canvasCtx.lineTo(foreheadX - 120, foreheadY - 100);
                canvasCtx.lineTo(foreheadX - 40, foreheadY - 60);
                canvasCtx.closePath();
                canvasCtx.fill();
                
                canvasCtx.beginPath();
                canvasCtx.moveTo(foreheadX + 80, foreheadY - 20);
                canvasCtx.lineTo(foreheadX + 120, foreheadY - 100);
                canvasCtx.lineTo(foreheadX + 40, foreheadY - 60);
                canvasCtx.closePath();
                canvasCtx.fill();
            } else if (activeEffect === 'flower') {
                const foreheadX = forehead.x * canvasW;
                const foreheadY = forehead.y * canvasH;
                
                for (let i = 0; i < 8; i++) {
                    const angle = (Math.PI * 2 * i) / 8;
                    const x = foreheadX + Math.cos(angle) * 40;
                    const y = foreheadY - 80 + Math.sin(angle) * 40;
                    
                    canvasCtx.fillStyle = '#FF69B4';
                    canvasCtx.beginPath();
                    canvasCtx.arc(x, y, 15, 0, Math.PI * 2);
                    canvasCtx.fill();
                }
                
                canvasCtx.fillStyle = '#FFD700';
                canvasCtx.beginPath();
                canvasCtx.arc(foreheadX, foreheadY - 80, 20, 0, Math.PI * 2);
                canvasCtx.fill();
            } else if (activeEffect === 'sparkle') {
                const leftEyeX = leftEye.x * canvasW;
                const leftEyeY = leftEye.y * canvasH;
                const rightEyeX = rightEye.x * canvasW;
                const rightEyeY = rightEye.y * canvasH;
                
                drawStar(canvasCtx, leftEyeX - 40, leftEyeY - 40, 15, '#FFD700');
                drawStar(canvasCtx, rightEyeX + 40, rightEyeY - 40, 15, '#FFD700');
                drawStar(canvasCtx, leftEyeX - 50, leftEyeY + 30, 10, '#FFA500');
                drawStar(canvasCtx, rightEyeX + 50, rightEyeY + 30, 10, '#FFA500');
            } else if (activeEffect === 'heart') {
                const leftCheek = landmarks[330];
                const rightCheek = landmarks[101];
                
                const leftX = leftCheek.x * canvasW;
                const leftY = leftCheek.y * canvasH;
                const rightX = rightCheek.x * canvasW;
                const rightY = rightCheek.y * canvasH;
                
                drawHeart(canvasCtx, leftX - 30, leftY, 20, '#FF1493');
                drawHeart(canvasCtx, rightX + 30, rightY, 20, '#FF1493');
            } else if (activeEffect === 'rainbow') {
                canvasCtx.globalAlpha = 0.3;
                const gradient = canvasCtx.createLinearGradient(0, 0, canvasW, 0);
                gradient.addColorStop(0, 'red');
                gradient.addColorStop(0.17, 'orange');
                gradient.addColorStop(0.33, 'yellow');
                gradient.addColorStop(0.5, 'green');
                gradient.addColorStop(0.67, 'blue');
                gradient.addColorStop(0.83, 'indigo');
                gradient.addColorStop(1, 'violet');
                canvasCtx.fillStyle = gradient;
                canvasCtx.fillRect(0, 0, canvasW, canvasH);
                canvasCtx.globalAlpha = 1.0;
            }
        }
        
        function drawStar(ctx, cx, cy, size, color) {
            ctx.save();
            ctx.fillStyle = color;
            ctx.shadowBlur = 10;
            ctx.shadowColor = color;
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                const x = cx + Math.cos(angle) * size;
                const y = cy + Math.sin(angle) * size;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
                const innerAngle = angle + Math.PI / 5;
                const innerX = cx + Math.cos(innerAngle) * (size / 2);
                const innerY = cy + Math.sin(innerAngle) * (size / 2);
                ctx.lineTo(innerX, innerY);
            }
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }
        
        function drawHeart(ctx, cx, cy, size, color) {
            ctx.save();
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(cx, cy + size / 4);
            ctx.bezierCurveTo(cx, cy, cx - size / 2, cy - size / 2, cx, cy - size);
            ctx.bezierCurveTo(cx + size / 2, cy - size / 2, cx, cy, cx, cy + size / 4);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }
        
        const hands = new Hands({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.1.1617147326/${file}`;
            }
        });
        
        hands.setOptions({
            maxNumHands: 2,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.5
        });
        
        hands.onResults(onResults);
        
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                if ((currentMode === 'quiz' || currentMode === 'photo') && faceMesh) {
                    await Promise.all([
                        faceMesh.send({image: videoElement}),
                        hands.send({image: videoElement})
                    ]);
                } else {
                    await hands.send({image: videoElement});
                }
            },
            width: 1280,
            height: 720
        });
        
        camera.start();
    </script>
</body>
</html>
